<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Uploader</title>
</head>

<body>
    <input type="file" id="upload-input" multiple="false">
    <hr />
    {% for x in ff %}
        <li>{{ x }}</li>
    {% endfor %}

    <script>
        
        const uploadInput = document.getElementById("upload-input");

        uploadInput.onchange = async (event) => {
            const file = event.target.files[0];

            if (file) {
                // get presigned urls
                const info = await get_presigned_urls(file.name, file.size, file.type);
                // split file into chunks & upload to s3
                const etags = await upload_to_s3(file, info.key, info.chunk_size, info.urls, info.content_type);
                // finish upload
                const url = await complete_upload(info.key, info.upload_id, etags)
                //if (url) {
                //    handleSuccess(url, file.type.includes('image'))
                //}
            }
        };


        const get_presigned_urls = async (file_name, file_size, content_type) => {

            try {
                const response = await fetch('create-upload/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'file_name': file_name,
                        'file_size': file_size,
                        'content_type': content_type,
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }

                const result = await response.json();

                return result;

                console.log('Success:', result);
            } catch (error) {
                console.error('Error:', error);
            }

        }

        const upload_to_s3 = async (file, key, chunk_size, urls, content_type) => {

            const etags = [];

            const chunks = to_chunks(file, chunk_size);
            for (let i = 0; i < chunks.length; i++) {
                try {
                    const etag = await upload_chunk(urls[i], chunks[i], file.type);
                    etags.push(etag)
                    console.log(`Chunk ${i + 1} of ${chunks.length} uploaded successfully`);
                    console.log(etags);
                } catch (error) {
                    console.error(`Error uploading chunk ${i + 1}:`, error);
                    break;
                }
            }
            return etags;
        }

        const to_chunks = (file, chunk_size) => {
            const chunks = [];
            let start = 0;

            while (start < file.size) {
                const end = Math.min(start + chunk_size, file.size);
                chunks.push(file.slice(start, end));
                start = end;
            }

            return chunks;
        }

        const upload_chunk = async (url, chunk) => {

            try {
                const response = await fetch(url, {
                    method: "PUT",
                    body: chunk,
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }

                return response.headers.get('Etag');

            } catch (error) {
                console.log("Error", error)
            }

        }

        const complete_upload = async (key, upload_id, etags) => {
            try {
                const response = await fetch('complete-upload/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'key': key,
                        'upload_id': upload_id,
                        'etags': etags.join(','),
                    })
                });


                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }

                const result = await response.json();

                return result['url'];

                console.log('Success:', result);
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }

        const handleSuccess = (url, isImage) => {
            console.log("Success", url);

            const section = document.createElement("section");


            if (isImage) {
                const img = document.createElement("img")
                img.src = url
                img.width = 300
                section.appendChild(img);
            }

            const link = document.createElement("a");
            link.href = url;
            link.target = "_blank"
            const linkText = document.createTextNode(url)
            link.appendChild(linkText)
            section.appendChild(document.createElement("div"))
            section.appendChild(link)


            document.body.appendChild(section)
            document.body.appendChild(document.createElement("hr"))


        }

    </script>
</body>

</html>